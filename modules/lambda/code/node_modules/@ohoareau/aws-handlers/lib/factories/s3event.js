"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const aws_1 = require("@ohoareau/aws");
const topper_1 = require("@ohoareau/topper");
const plugin = (source, { archive = true, run, ruleName, plugins, targetBucket = undefined, processedDir = 'archived/processed/:rule', errorsDir = 'archived/errors/:rule' }) => async (bucket, key) => {
    ruleName = ruleName || 'unknown-rule';
    targetBucket = targetBucket || bucket;
    let p = plugins[source];
    ('function' === typeof p) && (p = {
        execute: p,
    });
    const defaultInit = (async (x) => ({ ...x }));
    processedDir = processedDir.replace(':rule', ruleName);
    errorsDir = errorsDir.replace(':rule', ruleName);
    const getData = async () => aws_1.s3.getFileContent({ bucket, key, raw: true });
    const getTargetObject = to => ({ bucket: targetBucket, key: `${to ? to : ''}${to ? '/' : ''}${key}` });
    const copyFileFactory = to => async () => aws_1.s3.setFileContent(getTargetObject(to), await getData());
    const ctx = await (p.init || defaultInit)({ source, run, log: console.log, error: console.error });
    const processedTargetObject = getTargetObject(processedDir);
    const errorsTargetObject = getTargetObject(errorsDir);
    const formatObjectPath = o => `s3://${o.bucket}/${o.key}`;
    const processedTargetPath = formatObjectPath(processedTargetObject);
    const errorsTargetPath = formatObjectPath(errorsTargetObject);
    const defaults = { getData, bucket, key, source };
    const originalPath = formatObjectPath({ bucket, key });
    await run(['process', `rule: ${ruleName}, file: ${originalPath}`], async () => {
        p.load && (await run(['load', `file: ${originalPath}`], async () => p.load({ ...defaults }, ctx)));
        p.execute && (await run('execute', async () => p.execute({ ...defaults }, ctx)));
        archive && await run(['archive', processedTargetPath], copyFileFactory(processedDir));
    }, async (e) => {
        p.fail && (await run('fail', async () => p.fail({ ...defaults, error: e }, ctx)));
        archive && await run(['archive', errorsTargetPath], copyFileFactory(errorsDir));
        ctx.error(`File '${originalPath}' failed to be imported: ${e.message}`);
    }, async () => {
        p.clean && (await p.clean({ ...defaults }, ctx));
    });
};
const consumeS3 = ({ eventType = 'ObjectCreated', plugins = undefined, rules = [], ...rest }) => async (record) => {
    const bucket = record.s3.bucket['name'];
    const key = record.s3.object.key;
    const isHandledEventRecord = new RegExp(`^${eventType}`).test(record.eventName);
    const isDirectory = ('/' === key.charAt(key.length - 1));
    if (!isHandledEventRecord || isDirectory) {
        console.log(`Ignoring non-handled object '${key}' from bucket '${bucket}'.`);
        return;
    }
    const run = topper_1.createRunner();
    const hits = rules.reduce((acc, rule) => {
        rule = { clean: true, archive: true, ...rule };
        const patterns = rule.match ? (Array.isArray(rule.match) ? rule.match : [rule.match]) : [];
        const ignorePatterns = rule.ignore ? (Array.isArray(rule.ignore) ? rule.ignore : [rule.ignore]) : [];
        const foundPatternMatch = patterns.find(p => key.match(p));
        const foundIgnorePatternMatch = ignorePatterns.find(p => key.match(p));
        foundPatternMatch && !foundIgnorePatternMatch && acc.push({ rule, bucket, key });
        return acc;
    }, []);
    let error = undefined;
    const { clean } = hits.reduce((acc, item) => {
        !item.clean && (acc.clean = false);
        return acc;
    }, { clean: true });
    try {
        await Promise.all(hits.map(async (hit) => {
            let fn = hit.rule.function;
            let localPlugins = plugins;
            if (hit.rule.plugin) {
                let pName = hit.rule.plugin;
                if ('string' !== typeof pName) {
                    localPlugins = { default: pName };
                    pName = 'default';
                }
                fn = plugin(pName, { ...rest, run, ruleName: hit.rule.name, plugins: localPlugins, archive: !!hit.rule.archive });
            }
            return fn(hit.bucket, hit.key);
        }));
    }
    catch (e) {
        error = e;
    }
    if (hits.length) {
        clean && (await run('clean', async () => aws_1.s3.deleteFile({ bucket, key })));
    }
    else {
        console.log(`incoming ${bucket}:${key} => IGNORED`);
    }
    if (error)
        throw error;
};
const consumerFactories = config => ({
    'aws:s3': consumeS3(config),
});
exports.default = config => async ({ Records = [] }) => {
    const consumers = consumerFactories(config);
    return Promise.all(Records.map(async (record) => (consumers[record['eventSource']] || (() => { }))(record)));
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiczNldmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9mYWN0b3JpZXMvczNldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHVDQUFpQztBQUNqQyw2Q0FBOEM7QUFFOUMsTUFBTSxNQUFNLEdBQUcsQ0FBQyxNQUFNLEVBQUUsRUFBQyxPQUFPLEdBQUcsSUFBSSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFlBQVksR0FBRyxTQUFTLEVBQUUsWUFBWSxHQUFHLDBCQUEwQixFQUFFLFNBQVMsR0FBRyx1QkFBdUIsRUFBQyxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFO0lBQ2pNLFFBQVEsR0FBRyxRQUFRLElBQUksY0FBYyxDQUFDO0lBQ3RDLFlBQVksR0FBRyxZQUFZLElBQUksTUFBTSxDQUFDO0lBQ3RDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QixDQUFDLFVBQVUsS0FBSyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHO1FBQzlCLE9BQU8sRUFBRSxDQUFDO0tBQ2IsQ0FBQyxDQUFDO0lBQ0gsTUFBTSxXQUFXLEdBQWEsQ0FBQyxLQUFLLEVBQUMsQ0FBQyxFQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDcEQsWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZELFNBQVMsR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNqRCxNQUFNLE9BQU8sR0FBRyxLQUFLLElBQUksRUFBRSxDQUFDLFFBQUUsQ0FBQyxjQUFjLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQ3hFLE1B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SUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLE9BQU8sRUFBRSxLQUFLLElBQUksRUFBRSxDQUFDLFFBQUUsQ0FBQyxVQUFVLENBQUMsRUFBQyxNQUFNLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDM0U7U0FBTTtRQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxNQUFNLElBQUksR0FBRyxhQUFhLENBQUMsQ0FBQztLQUN2RDtJQUNELElBQUksS0FBSztRQUFFLE1BQU0sS0FBSyxDQUFDO0FBQzNCLENBQUMsQ0FBQztBQUVGLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLFFBQVEsRUFBRSxTQUFTLENBQUMsTUFBTSxDQUFDO0NBQzlCLENBQUMsQ0FBQztBQUVILGtCQUFlLE1BQU0sQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUMsT0FBTyxHQUFHLEVBQUUsRUFBQyxFQUFFLEVBQUU7SUFDOUMsTUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDNUMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxFQUFFLENBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUMsQ0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQTtBQUN0SCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3MzfSBmcm9tICdAb2hvYXJlYXUvYXdzJztcbmltcG9ydCB7Y3JlYXRlUnVubmVyfSBmcm9tICdAb2hvYXJlYXUvdG9wcGVyJztcblxuY29uc3QgcGx1Z2luID0gKHNvdXJjZSwge2FyY2hpdmUgPSB0cnVlLCBydW4sIHJ1bGVOYW1lLCBwbHVnaW5zLCB0YXJnZXRCdWNrZXQgPSB1bmRlZmluZWQsIHByb2Nlc3NlZERpciA9ICdhcmNoaXZlZC9wcm9jZXNzZWQvOnJ1bGUnLCBlcnJvcnNEaXIgPSAnYXJjaGl2ZWQvZXJyb3JzLzpydWxlJ30pID0+IGFzeW5jIChidWNrZXQsIGtleSkgPT4ge1xuICAgIHJ1bGVOYW1lID0gcnVsZU5hbWUgfHwgJ3Vua25vd24tcnVsZSc7XG4gICAgdGFyZ2V0QnVja2V0ID0gdGFyZ2V0QnVja2V0IHx8IGJ1Y2tldDtcbiAgICBsZXQgcCA9IHBsdWdpbnNbc291cmNlXTtcbiAgICAoJ2Z1bmN0aW9uJyA9PT0gdHlwZW9mIHApICYmIChwID0ge1xuICAgICAgICBleGVjdXRlOiBwLFxuICAgIH0pO1xuICAgIGNvbnN0IGRlZmF1bHRJbml0ID0gPEZ1bmN0aW9uPihhc3luYyB4ID0+ICh7Li4ueH0pKTtcbiAgICBwcm9jZXNzZWREaXIgPSBwcm9jZXNzZWREaXIucmVwbGFjZSgnOnJ1bGUnLCBydWxlTmFtZSk7XG4gICAgZXJyb3JzRGlyID0gZXJyb3JzRGlyLnJlcGxhY2UoJzpydWxlJywgcnVsZU5hbWUpO1xuICAgIGNvbnN0IGdldERhdGEgPSBhc3luYyAoKSA9PiBzMy5nZXRGaWxlQ29udGVudCh7YnVja2V0LCBrZXksIHJhdzogdHJ1ZX0pO1xuICAgIGNvbnN0IGdldFRhcmdldE9iamVjdCA9IHRvID0+ICh7YnVja2V0OiB0YXJnZXRCdWNrZXQsIGtleTogYCR7dG8gPyB0byA6ICcnfSR7dG8gPyAnLycgOiAnJ30ke2tleX1gfSk7XG4gICAgY29uc3QgY29weUZpbGVGYWN0b3J5ID0gdG8gPT4gYXN5bmMgKCkgPT4gczMuc2V0RmlsZUNvbnRlbnQoZ2V0VGFyZ2V0T2JqZWN0KHRvKSwgYXdhaXQgZ2V0RGF0YSgpKTtcbiAgICBjb25zdCBjdHggPSBhd2FpdCAocC5pbml0IHx8IGRlZmF1bHRJbml0KSh7c291cmNlLCBydW4sIGxvZzogY29uc29sZS5sb2csIGVycm9yOiBjb25zb2xlLmVycm9yfSk7XG4gICAgY29uc3QgcHJvY2Vzc2VkVGFyZ2V0T2JqZWN0ID0gZ2V0VGFyZ2V0T2JqZWN0KHByb2Nlc3NlZERpcik7XG4gICAgY29uc3QgZXJyb3JzVGFyZ2V0T2JqZWN0ID0gZ2V0VGFyZ2V0T2JqZWN0KGVycm9yc0Rpcik7XG4gICAgY29uc3QgZm9ybWF0T2JqZWN0UGF0aCA9IG8gPT4gYHMzOi8vJHtvLmJ1Y2tldH0vJHtvLmtleX1gO1xuICAgIGNvbnN0IHByb2Nlc3NlZFRhcmdldFBhdGggPSBmb3JtYXRPYmplY3RQYXRoKHByb2Nlc3NlZFRhcmdldE9iamVjdCk7XG4gICAgY29uc3QgZXJyb3JzVGFyZ2V0UGF0aCA9IGZvcm1hdE9iamVjdFBhdGgoZXJyb3JzVGFyZ2V0T2JqZWN0KTtcbiAgICBjb25zdCBkZWZhdWx0cyA9IHtnZXREYXRhLCBidWNrZXQsIGtleSwgc291cmNlfTtcbiAgICBjb25zdCBvcmlnaW5hbFBhdGggPSBmb3JtYXRPYmplY3RQYXRoKHtidWNrZXQsIGtleX0pO1xuICAgIGF3YWl0IHJ1bihcbiAgICAgICAgWydwcm9jZXNzJywgYHJ1bGU6ICR7cnVsZU5hbWV9LCBmaWxlOiAke29yaWdpbmFsUGF0aH1gXSxcbiAgICAgICAgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgcC5sb2FkICYmIChhd2FpdCBydW4oWydsb2FkJywgYGZpbGU6ICR7b3JpZ2luYWxQYXRofWBdLCBhc3luYyAoKSA9PiBwLmxvYWQoey4uLmRlZmF1bHRzfSwgY3R4KSkpO1xuICAgICAgICAgICAgcC5leGVjdXRlICYmIChhd2FpdCBydW4oJ2V4ZWN1dGUnLCBhc3luYyAoKSA9PiBwLmV4ZWN1dGUoey4uLmRlZmF1bHRzfSwgY3R4KSkpO1xuICAgICAgICAgICAgYXJjaGl2ZSAmJiBhd2FpdCBydW4oWydhcmNoaXZlJywgcHJvY2Vzc2VkVGFyZ2V0UGF0aF0sIGNvcHlGaWxlRmFjdG9yeShwcm9jZXNzZWREaXIpKTtcbiAgICAgICAgfSxcbiAgICAgICAgYXN5bmMgZSA9PiB7XG4gICAgICAgICAgICBwLmZhaWwgJiYgKGF3YWl0IHJ1bignZmFpbCcsIGFzeW5jICgpID0+IHAuZmFpbCh7Li4uZGVmYXVsdHMsIGVycm9yOiBlfSwgY3R4KSkpO1xuICAgICAgICAgICAgYXJjaGl2ZSAmJiBhd2FpdCBydW4oWydhcmNoaXZlJywgZXJyb3JzVGFyZ2V0UGF0aF0sIGNvcHlGaWxlRmFjdG9yeShlcnJvcnNEaXIpKTtcbiAgICAgICAgICAgIGN0eC5lcnJvcihgRmlsZSAnJHtvcmlnaW5hbFBhdGh9JyBmYWlsZWQgdG8gYmUgaW1wb3J0ZWQ6ICR7ZS5tZXNzYWdlfWApXG4gICAgICAgIH0sXG4gICAgICAgIGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHAuY2xlYW4gJiYgKGF3YWl0IHAuY2xlYW4oey4uLmRlZmF1bHRzfSwgY3R4KSk7XG4gICAgICAgIH1cbiAgICApO1xufTtcblxuY29uc3QgY29uc3VtZVMzID0gKHtldmVudFR5cGUgPSAnT2JqZWN0Q3JlYXRlZCcsIHBsdWdpbnMgPSB1bmRlZmluZWQsIHJ1bGVzID0gW10sIC4uLnJlc3R9OiB7ZXZlbnRUeXBlPzogc3RyaW5nLCBwbHVnaW5zPzogYW55LCBydWxlcz86IGFueVtdfSkgPT4gYXN5bmMgcmVjb3JkID0+IHtcbiAgICBjb25zdCBidWNrZXQgPSByZWNvcmQuczMuYnVja2V0WyduYW1lJ107XG4gICAgY29uc3Qga2V5ID0gcmVjb3JkLnMzLm9iamVjdC5rZXk7XG4gICAgY29uc3QgaXNIYW5kbGVkRXZlbnRSZWNvcmQgPSBuZXcgUmVnRXhwKGBeJHtldmVudFR5cGV9YCkudGVzdChyZWNvcmQuZXZlbnROYW1lKTtcbiAgICBjb25zdCBpc0RpcmVjdG9yeSA9ICgnLycgPT09IGtleS5jaGFyQXQoa2V5Lmxlbmd0aCAtIDEpKTtcbiAgICBpZiAoIWlzSGFuZGxlZEV2ZW50UmVjb3JkIHx8IGlzRGlyZWN0b3J5KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBJZ25vcmluZyBub24taGFuZGxlZCBvYmplY3QgJyR7a2V5fScgZnJvbSBidWNrZXQgJyR7YnVja2V0fScuYClcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBydW4gPSBjcmVhdGVSdW5uZXIoKTtcbiAgICBjb25zdCBoaXRzID0gcnVsZXMucmVkdWNlKChhY2MsIHJ1bGUpID0+IHtcbiAgICAgICAgcnVsZSA9IHtjbGVhbjogdHJ1ZSwgYXJjaGl2ZTogdHJ1ZSwgLi4ucnVsZX07XG4gICAgICAgIGNvbnN0IHBhdHRlcm5zID0gcnVsZS5tYXRjaCA/IChBcnJheS5pc0FycmF5KHJ1bGUubWF0Y2gpID8gcnVsZS5tYXRjaCA6IFtydWxlLm1hdGNoXSkgOiBbXTtcbiAgICAgICAgY29uc3QgaWdub3JlUGF0dGVybnMgPSBydWxlLmlnbm9yZSA/IChBcnJheS5pc0FycmF5KHJ1bGUuaWdub3JlKSA/IHJ1bGUuaWdub3JlIDogW3J1bGUuaWdub3JlXSkgOiBbXTtcbiAgICAgICAgY29uc3QgZm91bmRQYXR0ZXJuTWF0Y2ggPSBwYXR0ZXJucy5maW5kKHAgPT4ga2V5Lm1hdGNoKHApKTtcbiAgICAgICAgY29uc3QgZm91bmRJZ25vcmVQYXR0ZXJuTWF0Y2ggPSBpZ25vcmVQYXR0ZXJucy5maW5kKHAgPT4ga2V5Lm1hdGNoKHApKTtcbiAgICAgICAgZm91bmRQYXR0ZXJuTWF0Y2ggJiYgIWZvdW5kSWdub3JlUGF0dGVybk1hdGNoICYmIGFjYy5wdXNoKHtydWxlLCBidWNrZXQsIGtleX0pO1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgIH0sIFtdKTtcbiAgICBsZXQgZXJyb3IgPSB1bmRlZmluZWQ7XG4gICAgY29uc3Qge2NsZWFufSA9IGhpdHMucmVkdWNlKChhY2MsIGl0ZW0pID0+IHtcbiAgICAgICAgIWl0ZW0uY2xlYW4gJiYgKGFjYy5jbGVhbiA9IGZhbHNlKTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7Y2xlYW46IHRydWV9KVxuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKGhpdHMubWFwKGFzeW5jIGhpdCA9PiB7XG4gICAgICAgICAgICBsZXQgZm4gPSBoaXQucnVsZS5mdW5jdGlvbjtcbiAgICAgICAgICAgIGxldCBsb2NhbFBsdWdpbnMgPSBwbHVnaW5zO1xuICAgICAgICAgICAgaWYgKGhpdC5ydWxlLnBsdWdpbikge1xuICAgICAgICAgICAgICAgIGxldCBwTmFtZSA9IGhpdC5ydWxlLnBsdWdpbjtcbiAgICAgICAgICAgICAgICBpZiAoJ3N0cmluZycgIT09IHR5cGVvZiBwTmFtZSkge1xuICAgICAgICAgICAgICAgICAgICBsb2NhbFBsdWdpbnMgPSB7ZGVmYXVsdDogcE5hbWV9O1xuICAgICAgICAgICAgICAgICAgICBwTmFtZSA9ICdkZWZhdWx0JztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZm4gPSBwbHVnaW4ocE5hbWUsIHsuLi5yZXN0LCBydW4sIHJ1bGVOYW1lOiBoaXQucnVsZS5uYW1lLCBwbHVnaW5zOiBsb2NhbFBsdWdpbnMsIGFyY2hpdmU6ICEhaGl0LnJ1bGUuYXJjaGl2ZX0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gKGZuIGFzIGFueSkoaGl0LmJ1Y2tldCwgaGl0LmtleSk7XG4gICAgICAgIH0pKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGVycm9yID0gZTtcbiAgICB9XG4gICAgaWYgKGhpdHMubGVuZ3RoKSB7XG4gICAgICAgIGNsZWFuICYmIChhd2FpdCBydW4oJ2NsZWFuJywgYXN5bmMgKCkgPT4gczMuZGVsZXRlRmlsZSh7YnVja2V0LCBrZXl9KSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGBpbmNvbWluZyAke2J1Y2tldH06JHtrZXl9ID0+IElHTk9SRURgKTtcbiAgICB9XG4gICAgaWYgKGVycm9yKSB0aHJvdyBlcnJvcjtcbn07XG5cbmNvbnN0IGNvbnN1bWVyRmFjdG9yaWVzID0gY29uZmlnID0+ICh7XG4gICAgJ2F3czpzMyc6IGNvbnN1bWVTMyhjb25maWcpLFxufSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNvbmZpZyA9PiBhc3luYyAoe1JlY29yZHMgPSBbXX0pID0+IHtcbiAgICBjb25zdCBjb25zdW1lcnMgPSBjb25zdW1lckZhY3Rvcmllcyhjb25maWcpO1xuICAgIHJldHVybiBQcm9taXNlLmFsbChSZWNvcmRzLm1hcChhc3luYyByZWNvcmQgPT4gKChjb25zdW1lcnNbcmVjb3JkWydldmVudFNvdXJjZSddXSB8fCAoKCkgPT4ge30pKSBhcyBhbnkpKHJlY29yZCkpKVxufTtcbiJdfQ==